services:
  web:
    # Build from your Dockerfile in this folder
    build:
      context: .
      dockerfile: Dockerfile
    image: fastapi-uv:latest

    # Safer default: expose only on localhost (change to "8000:8000" for LAN)
    ports:
      - "127.0.0.1:8000:8000"

    # Override baked-in defaults without rebuilding (optional)
    environment:
      CHAT_MODEL_REPO: ${CHAT_MODEL_REPO:-Qwen/Qwen3-0.6B}

    # Let Docker restart on crashes / after reboot
    restart: unless-stopped

    # Graceful shutdown window for Uvicorn (SIGTERM -> graceful)
    stop_grace_period: 20s

    # Healthcheck (overrides the one in the image if present)
    healthcheck:
      test: ["CMD", "python", "-c", "import sys,urllib.request,json; r=urllib.request.urlopen('http://127.0.0.1:8000/healthz', timeout=2); sys.exit(0 if (r.status==200 and json.loads(r.read().decode()).get('status')=='ok') else 1)"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    # Keep logs from exploding on disk
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # Dev UX: live code sync + auto-rebuild on lockfile changes
    # Requires: Docker Compose v2.22+ and `docker compose watch`
    develop:
      watch:
        - action: sync
          path: .
          target: /app
          ignore:
            - .venv/
            - .git/
            - __pycache__/
            - .mypy_cache/
            - .pytest_cache/
        - action: rebuild
          path: ./uv.lock
